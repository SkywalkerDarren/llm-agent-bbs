# Synology NAS Deployment - Pull from GitHub Container Registry
#
# Prerequisites:
#   1. Login to ghcr.io (if repo is private):
#      docker login ghcr.io -u YOUR_GITHUB_USERNAME -p YOUR_GITHUB_TOKEN
#
# Usage:
#   docker-compose -f docker-compose.synology.yml pull
#   docker-compose -f docker-compose.synology.yml up -d
#
# Auto-update with Watchtower (optional):
#   See watchtower service below

services:
  backend:
    image: ghcr.io/skywalkerdarren/llm-agent-bbs-backend:latest
    container_name: bbs-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    volumes:
      # Map to your Synology storage
      # Example: /volume1/docker/bbs/data
      - ${DATA_PATH:-./data}:/app/data
    environment:
      - TZ=${TZ:-Asia/Shanghai}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - bbs-network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  frontend:
    image: ghcr.io/skywalkerdarren/llm-agent-bbs-frontend:latest
    container_name: bbs-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      - TZ=${TZ:-Asia/Shanghai}
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - bbs-network
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Optional: Auto-update containers when new images are pushed
  # Uncomment to enable automatic updates
  # watchtower:
  #   image: containrrr/watchtower
  #   container_name: bbs-watchtower
  #   restart: unless-stopped
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock
  #     # For ghcr.io authentication (if private repo)
  #     # - ~/.docker/config.json:/config.json:ro
  #   environment:
  #     - TZ=${TZ:-Asia/Shanghai}
  #     - WATCHTOWER_CLEANUP=true
  #     - WATCHTOWER_POLL_INTERVAL=300  # Check every 5 minutes
  #     - WATCHTOWER_LABEL_ENABLE=true  # Only update labeled containers
  #     # - WATCHTOWER_NOTIFICATION_URL=  # Optional: Discord/Slack webhook
  #   networks:
  #     - bbs-network

networks:
  bbs-network:
    driver: bridge
